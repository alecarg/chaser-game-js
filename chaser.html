<!DOCTYPE html>
<html>
<head>
  <title>Ale jueguito</title>
  <style>
  html, body {
    height: 100%;
    margin: 0;
  }
  body {
    background: url('http://cheapmichaelkorshandbags.com.co/wp-content/uploads/2018/07/Gradient-Background.png');
  }
  canvas {
    position:absolute;
    top: 10px;
    left: 0;
  }
  canvas.zoomed {
    width: 100%;
  }
  .left-panel {
    position: fixed;
    bottom: 10px;
    left: 10px;
    width: 45%;
  }
  .right-panel {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 45%;
  }
  .log {
    height: 150px;
    width: 100%;
    border: 1px dashed grey;
    background: white;
    opacity: 0.7;
    padding: 10px 20px;
    overflow-x: hidden;
  }
  .log p {
    margin-bottom: 5px; 
    margin-top: 2px;
    font-family: 'verdana';
    font-size: 9px;
    position: relative;
  }
  .log p.attention-calling {
    color: green;
  }
  .restart {
    position: relative;
    left: 0px;
    top: -10px;
  }
  .code {
    width: 90%;
    padding: 10px;
    position: relative;
    bottom: -8px;
  }
  .code .CodeMirror {
    height: 170px;
  }
  .turn-ui {
    margin-left: 10px;
    position: relative;
    top: -10px;
  }
  </style>
  <link rel="stylesheet" type="text/css" href="lib/codemirror/codemirror.css">
  <link rel="stylesheet" type="text/css" href="lib/codemirror/codemirror__fullscreen.css">
</head>
<body>

<canvas id="main"></canvas>
<div class="left-panel">
  <button class="restart" onclick="game.restart()">Restart</button>
  <span class="turn-ui">Turn: <b>0</b></span>
  <div class="log"></div>
</div>
<div class="right-panel">
  <div class="code"></div>
</div>

<script type="text/javascript" src="lib/codemirror/codemirror.js"></script>
<script type="text/javascript" src="lib/codemirror/codemirror__fullscreen.js"></script>
<script type="text/javascript" src="lib/codemirror/codemirror__javascript.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
<script type="text/javascript">

// Tutorials
// http://jsiso.com/tutorials/2014/10/26/tile-engine-basics.html
// http://nicolahibbert.com/demo/javascript-tile-map-editor/
  
var game = {
  turn: 0,
  turnSpeed: null,
  turnSpeedInitial: 500,
};
// class Player()
var players = [];
// class Chaser()
var chaser = {};
var logger = {};
var helpers = {};
var board = {
  tileGraphics: [],
  // Set as your tile pixel sizes, alter if you are using larger tiles.
  tileH: 28,
  // tileW: 52,
  // DOM element size
  canvasWidth: 2000,
  canvasHeight: 1500
};
// mapX and mapY are offsets to make sure we can position the map as we want.
board.mapX = board.canvasWidth / 2;
board.mapY = board.canvasHeight / 1000;
// land an water (0 == water)
board.tiles = [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];
var startingCode = "\
var fiftyFifty = ((Math.random() * 100) > 50);\n\
if (fiftyFifty){\n\
  this.move('right');\n\
} else {\n\
  this.move('down');\n\
}\n\
";

game.init = function(){
  window.removeEventListener('load', game.init);

  game.turnSpeed = game.turnSpeedInitial;
  game.instantiatePlayers();
  game.instantiateChaser();
  board.create();
  game.passTurn();

  helpers.initialiseCodeUI();
}

game.restart = function(){
  game.turn = 0;
  game.turnSpeed = game.turnSpeedInitial;
  game.instantiatePlayers();
  game.instantiateChaser();
  logger.clearLog();
}

game.passTurn = function(){
  game.turn++;
  document.querySelector('.turn-ui b').innerHTML = game.turn;

  if (players.length < 1){
    alert('Game over. Your escapers survived: ' + game.turn + ' turns.');
    game.restart();
  }

  if (game.turn > 1000){
    alert('Game timeout. 1000 turns are way too many.');
    game.restart(); 
  }

  setTimeout(function(){
    game.passTurn();
    game.onNewTurn();
  }, game.turnSpeed);
}

game.onNewTurn = function(){
   chaser.onNewTurn();

   helpers.forAllPlayers(function(i, p){
     p.setCurrDistanceToChaser();
     p.onNewTurnFromLiveCode(); // p.onNewTurn();
     board.draw();
   });
   game.checkForDrownings();

   game.turnSpeed = game.turnSpeed * 0.98;
}

game.instantiatePlayers = function(){
  var playersToSpawn = 7;
  for (var i = 0; i < playersToSpawn; i++) {
    var playerUid = i;
    var playerPosX = Math.floor((Math.random() * Math.floor(10) + 5));
    var playerPosY = 2 + i;
    players[i] = new Player(playerPosX, playerPosY, playerUid);
  }
}

game.instantiateChaser = function(){
  chaser = new Chaser(1, 5);
}

game.checkForDrownings = function(){
  helpers.forAllPlayers(function(i, player){
    var currPlayerTile = helpers.getPlayerBoardTile(player);
    var isPlayerInWater = (currPlayerTile == 0);
    if (isPlayerInWater){
        setTimeout(function(){
          logger.log(player.number + ' has drowned.');
          game.killPlayer(player, true);
        }, 0);
      }
  });
}

game.killPlayer = function(player){
    logger.log(player.number + ' has died. It survived ' + game.turn + ' turns.');
    var playerPosInArray = helpers.getPlayerIndexInPlayersArr(player);
    players.splice(playerPosInArray, 1);
}

board.create = function(){
  
  // Set initial board size
  var canvas = document.getElementById('main');
  canvas.width = board.canvasWidth;
  canvas.height = board.canvasHeight;

  board.loadAssets(function(err){
    if (err !== null){
      console.log(err);
    } else {
      board.draw();
    }
  });
}

board.loadAssets = function(callback) {
      
    // Images to be loaded and used.
    // As water is loaded first it will be represented by a 0 on the map and land will be a 1.
    var tileGraphicsToLoad = [
      "assets/water.png", // 0 (water)
      "assets/land.png", // 1 (land)
      "assets/chaser.png", // 2 (chaser)
      "assets/ralph.png" // 3 (player)
    ],
    tileGraphicsLoaded = 0;

    for (var i = 0; i < tileGraphicsToLoad.length; i++) {
      board.tileGraphics[i] = new Image();
      board.tileGraphics[i].src = tileGraphicsToLoad[i];
      board.tileGraphics[i].onload = function() {
        // Check if all images are ready.
        tileGraphicsLoaded++;
        if (tileGraphicsLoaded === tileGraphicsToLoad.length) {
            callback(null, {});
        }
      }
    }
}

board.draw = function() {

    // create the canvas context
    var ctx = document.getElementById('main').getContext('2d');

    // clear the canvas
    ctx.clearRect(0, 0, 2500, 2500);

    // loop through our map and draw out the image represented by the number.
    for (var i = 0; i < board.tiles.length; i++) {
      for (var j = 0; j < board.tiles[i].length; j++) {
        board.drawTerrain(ctx, i, j);
        board.drawCharacters(ctx, i, j);
      }
    }
}

board.drawTerrain = function(ctx, i, j) {

  var drawX = (i - j) * board.tileH + board.mapX;
  var drawY = (i + j) * board.tileH / 2 + board.mapY;

  tileToDraw = board.getTile(i, j); // 0 or 1 = map
  ctx.drawImage(board.tileGraphics[tileToDraw], drawX, drawY);
}

board.drawCharacters = function(ctx, i, j) {

  var drawX = (i - j) * board.tileH + board.mapX;
  var drawY = (i + j) * board.tileH / 2 + board.mapY;
  
  var characterElevation = 52; // things "on" the board are offsetedY to look on top
  var isChaserInCurrTile = (chaser.pos.x === i && chaser.pos.y === j);
  var playerInCurrTile = helpers.getPlayerByCoords(i, j);

  if (isChaserInCurrTile) {

    ctx.drawImage(board.tileGraphics[2], drawX, drawY - characterElevation);

  } else if (playerInCurrTile) {

    ctx.drawImage(board.tileGraphics[3], drawX, drawY - characterElevation);

    // Draw player's number
    var playerUid = playerInCurrTile.number.toString();
    ctx.font = '18px Verdana';
    ctx.fillText(playerUid, drawX, drawY);
  }
}

board.getTile = function(x, y){
  try {
    var tile = board.tiles[x][y];
  } catch(e){
    console.log('Tried to get tile outside of map.');
    game.restart();
  }
  return tile;
}

class Player {
  constructor(posx, posy, uid){
    this.uid = uid;
    this.number = uid + 1;

    this.pos = {};
    this.pos.x = posx;
    this.pos.y = posy;

    this.distanceToChaser = {};

    this.direction = null;
  }

  setCurrDistanceToChaser(){
    this.distanceToChaser.x = Math.abs(chaser.pos.x - this.pos.x);
    this.distanceToChaser.y = Math.abs(chaser.pos.y - this.pos.y);
    this.distanceToChaser.total = this.distanceToChaser.x + this.distanceToChaser.y;
  }

  move(direction){
    if (direction == 'left'){
      this.pos.x--;
    } else
    if (direction == 'right'){
      this.pos.x++;
    } else
    if (direction == 'up'){
      this.pos.y--;
    } else
    if (direction == 'down'){
      this.pos.y++;
    }
  }

  onNewTurn(){
    
  }

  onNewTurnFromLiveCode(){
    eval(codeMirror.getValue());
  }
}

class Chaser {
  constructor(posx, posy){
    this.pos = {};
    this.pos.x = posx;
    this.pos.y = posy;
  }

  onNewTurn(){
    var turnsToTake = 1;

    if (game.turn >= 50){
      if (game.turn == 50){ logger.log('Game difficulty now MEDIUM. Chaser moves 2 squares.', 'attentionCalling'); };
      turnsToTake = 2;
    }
    
    if (game.turn >= 100){
      if (game.turn == 100){ logger.log('Game difficulty now HARD. Chaser moves 3 squares.', 'attentionCalling') };
      turnsToTake = 3;
    }

    this.takeTurn(turnsToTake);
  }

  takeTurn(quantity){
    for (var i = 0; i < quantity; i++) {
      this.move();
      this.checkHasEaten();
      board.draw();
    }
  }

  move(){
    var closestPlayer = chaser.findClosestPlayer();

    var distanceXToClosestPlayer = Math.abs(chaser.pos.x - closestPlayer.pos.x);
    var distanceYToClosestPlayer = Math.abs(chaser.pos.y - closestPlayer.pos.y);
    var axis = (distanceXToClosestPlayer > distanceYToClosestPlayer) ? 'x' : 'y'; // axis most lagging
    var directionDiff = (chaser.pos[axis] > closestPlayer.pos[axis]) ? -1 : 1;
    
    chaser.pos[axis] = chaser.pos[axis] + directionDiff;
  }

  findClosestPlayer(){
    var playersSortedByDistance = _.sortBy(players, [function(p) { return p.distanceToChaser.total; }]);
    // console.log('closest: ' + playersSortedByDistance[0].uid + '(uid) / ' + playersSortedByDistance[0].number + '(number)');
    return playersSortedByDistance[0];
  }

  checkHasEaten(){
    setTimeout(function(){
      var playerOnChaserTile = _.find(players, function(player) { 
        if (player.pos.x === chaser.pos.x && player.pos.y === chaser.pos.y){
          return player;
        } else {
          return null;
        }
      });

      if (playerOnChaserTile){
        game.killPlayer(playerOnChaserTile);
      }
    }, 0);
  }
}

logger.log = function(message, attentionCalling){
  var log = document.querySelector('.log');
  var attentionCallingClass = attentionCalling ? 'attention-calling' : '';
  log.innerHTML += '<p class="' + attentionCallingClass + '">' + message + '</p>';
  log.scrollTop = log.scrollHeight;
}

logger.clearLog = function(){
  var log = document.querySelector('.log');
  log.innerHTML = '';
}

helpers.getPlayerByCoords = function(x, y){
  return _.find(players, function(p) { return (p.pos.x === x && p.pos.y === y) });
}

helpers.getPlayerByPlayerUid = function(playerUid){
  return _.find(players, function(p) { return (p.uid === playerUid) });
}

helpers.getPlayerBoardTile = function(player){
  return board.getTile(player.pos.x, player.pos.y);
}

helpers.getPlayerIndexInPlayersArr = function(player){
  return _.findIndex(players, function(p) { return (p.uid === player.uid) });
}

helpers.forAllPlayers = function(callback){
  for (var i = 0; i < players.length; i++) {
      callback(i, players[i]);
    }
}

helpers.initialiseCodeUI = function(){
  var textarea = document.querySelector('.code');
  window.codeMirror = CodeMirror(textarea, {
    value: startingCode,
    lineNumbers: true,
    mode: 'javascript',
    fullscreen: true,
    electricChars: true,
    extraKeys: {
      "F11": function(cm) {
        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
      },
      "Esc": function(cm) {
        if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
      }
    }
  });
}

// Add Event Listener to dectect when page has fully loaded.
window.addEventListener('load', game.init, false);

</script>
</body>
</html>